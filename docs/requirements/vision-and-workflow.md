# 願景與工作流程

**最後更新**: 2025-10-30
**狀態**: 持續更新文檔

## 概述

Flourish 是一個個人財務管理系統，專為需要高效處理每月帳單和智慧預算管理（含預扣功能）的信用卡重度使用者設計。

---

## 使用者輪廓與情境

### 目標使用者

**信用卡重度使用者**

- 擁有 20+ 張信用卡以獲取各種回饋與優惠
- 根據促銷活動每月積極使用 2-5 張卡片
- 以月為單位處理帳單（非每日記錄交易）
- 重視效率與自動化，而非手動輸入資料
- 需要清楚了解扣除預扣項目後的實際可用預算

### 歷史背景

**先前解決方案**: Google Sheets (2019-2025)

- **痛點**:
  - 年費分攤的複雜公式（除以 12）
  - 訂閱服務的手動預扣追蹤
  - 維護困難，每年需要重建
  - 經過數年後資料用途不明確
  - 每月對帳耗時

**資料量**:

- 6 年的歷史交易資料 (2019-2025)
- 優先級：近期資料 (2024-2025) 供立即匯入
- 完整歷史：時間允許時匯入

---

## 主要工作流程：PDF 帳單處理

### 每月週期

```
每月固定流程：
1. 下載信用卡 PDF 對帳單（網路銀行）
2. 上傳 PDF 到 Flourish
3. AI 自動辨識交易明細
4. 檢視並確認交易（修正錯誤）
5. 批次匯入到資料庫
6. 檢視當月預算使用狀況
```

### 工作流程細節

#### 步驟 1：下載帳單

- 來源：網路銀行入口網站
- 格式：PDF 檔案（各家銀行格式不同）
- 頻率：每月帳單日期後
- 卡片：僅下載當月使用的卡片（2-5 張/月）

#### 步驟 2：上傳 PDF

- **使用者操作**：選擇卡片、上傳 PDF 檔案
- **系統操作**：將 PDF 儲存至雲端儲存、建立 Statement 記錄
- **UI 需求**:
  - 卡片選擇下拉選單（優先顯示使用中的卡片）
  - 檔案上傳進度指示器
  - 支援拖放上傳
  - 檔案大小限制：每個 PDF 10MB

#### 步驟 3：AI 交易辨識

- **系統操作**:
  - 使用 OCR/AI 提取交易資料
  - 解析：日期、商家名稱、金額、交易類型
  - 為每筆交易計算信心分數
  - 將交易連結至帳單
- **技術方案**：OpenAI Vision API（提議）
- **資料品質**：儲存原始 OCR 文字供驗證

#### 步驟 4：檢視與驗證

- **使用者操作**:
  - 在表格視圖中檢視提取的交易
  - 編輯商家名稱（標準化命名）
  - 指定分類
  - 移除錯誤的提取結果
  - 標記可疑交易
- **UI 需求**:
  - 可內嵌編輯的表格
  - 顯示信心分數指示器
  - 批次分類指定
  - 快速刪除錯誤項目

#### 步驟 5：批次匯入

- **使用者操作**：點擊「確認匯入」按鈕
- **系統操作**:
  - 將所有已驗證的交易儲存到資料庫
  - 標記帳單為已處理
  - 更新月度預算計算
  - 觸發分類統計更新
- **驗證**：確保沒有重複交易

#### 步驟 6：預算檢視

- **使用者操作**：查看月度預算儀表板
- **顯示需求**:
  - 本月總收入
  - 預扣金額（訂閱、分攤費用、自動儲蓄）
  - 帳單總支出
  - **實際可用餘額**（最重要的指標）
  - 分類明細
  - 與前幾個月的比較

---

## 多卡管理

### 卡片庫存

**總卡片數**：20+ 張信用卡
**使用中卡片**：每月使用 2-5 張卡片
**輪換策略**：根據以下條件使用不同卡片：

- 當前促銷活動（現金回饋、點數）
- 消費分類加碼
- 年費合理性

### 卡片管理需求

#### 卡片資訊

- 卡片名稱（使用者自訂，例如「國泰世華 CUBE」）
- 銀行名稱
- 卡號末 4 碼
- 卡片顏色（用於視覺識別）
- 啟用/停用狀態

#### 使用中卡片管理

- **標記為使用中**：目前在錢包/使用中的卡片
- **標記為停用**：已收起、不在當前輪換中的卡片
- **顯示優先級**：在所有下拉選單中優先顯示使用中的卡片

#### 帳單組織

- 將每份帳單連結至特定卡片
- 依卡片篩選帳單
- 查看卡片使用歷史
- 追蹤每張卡片的消費模式

---

## 預扣系統

### 目的

**計算實際可用金額**，從當前收入中預先扣除預期的未來支出。

### 公式

```
實際可用金額 = 總收入 - 自動儲蓄 - 固定月費 - 分攤年費
```

### 預扣分類

#### 1. 固定月費訂閱

**範例**:

- YouTube Premium: NT$179/月
- Netflix: NT$390/月
- iCloud Storage: NT$90/月

**行為**:

- 從可用預算自動扣除
- 追蹤實際 vs 預期交易
- 訂閱金額變更時發出警告
- 顯示在月度預算預測中

#### 2. 年費分攤

**目的**：避免大額年度扣款造成預算衝擊

**範例**:

- 信用卡年費：NT$10,000/年 → NT$833/月
- 網域續約：NT$500/年 → NT$42/月
- 專業會員：NT$5,000/年 → NT$417/月

**計算**:

```
每月分攤金額 = 年度費用總額 ÷ 12
```

**行為**:

- 顯示為每月「保留金額」
- 當實際年度扣款發生時，與保留金額進行匹配
- 防止重複計算（保留 vs 實際）

#### 3. 自動儲蓄規則

**目的**：強制執行持續的儲蓄行為

**範例**:

- 緊急基金：月收入的 5%
- 投資基金：固定 NT$5,000
- 退休儲蓄：收入的 10%

**類型**:

- **百分比制**：收入的 %
- **固定金額**：特定 NT$ 金額

**計算**:

```
儲蓄金額 =
  (收入 × 百分比規則總和) + 固定金額規則總和
```

---

## 預算計算與顯示

### 月度預算公式

```typescript
// 步驟 1: 計算總收入
const totalIncome = sumOfAllIncomeTransactions;

// 步驟 2: 計算自動儲蓄
const autoSaving = totalIncome * savingPercentage + fixedSavingAmount;

// 步驟 3: 計算固定月費總額
const monthlySubscriptions = sumOfRecurringMonthlyExpenses;

// 步驟 4: 計算分攤年費總額
const amortizedAnnualFees = sumOfAnnualExpenses / 12;

// 步驟 5: 計算實際可用金額
const availableBudget = totalIncome - autoSaving - monthlySubscriptions - amortizedAnnualFees;

// 步驟 6: 計算已花費金額
const totalSpent = sumOfActualTransactions;

// 步驟 7: 計算剩餘金額
const remainingBudget = availableBudget - totalSpent;
```

### 顯示需求

**預算儀表板必須顯示**:

1. **收入區塊**
   - 💰 本月收入：NT$50,000
   - 📊 收入明細：薪資、獎金、其他

2. **預扣區塊**（最重要）
   - 💾 自動儲蓄：NT$2,500 (5%)
   - 📱 固定月費：NT$659
   - 📅 分攤年費：NT$1,664
   - ➖ 預扣總額：NT$4,823

3. **可用預算**（關鍵指標）
   - ✅ **實際可用：NT$45,177**
   - 這是使用者最關心的數字

4. **支出區塊**
   - 💳 已消費：NT$32,450
   - 📊 分類明細：餐飲、交通、購物等
   - 🎯 剩餘額度：NT$12,727

5. **比較**
   - 📈 較上月：+5% / -5%
   - 🎯 預算達成率：72%

---

## 歷史資料匯入

### 來源：Google Sheets (2019-2025)

#### 資料結構

```
欄位：
- Date: 交易日期
- Card: 信用卡名稱
- Merchant: 商家名稱
- Amount: 金額
- Category: 分類
- Note: 備註
```

#### 匯入策略

**階段 1：近期資料（優先）**

- 重點：2024-2025 資料
- 理由：與當前預算分析最相關
- 方法：透過管理介面手動上傳 CSV

**階段 2：完整歷史（選用）**

- 時間範圍：2019-2023 資料
- 方法：批次匯入腳本
- 目的：歷史趨勢分析

#### 資料驗證

- ✅ 檢查重複交易（依日期 + 金額 + 商家）
- ✅ 驗證卡片名稱是否與現有卡片匹配
- ✅ 缺少分類時自動建立
- ✅ 標記大額交易供檢視（>NT$10,000）
- ✅ 將所有匯入資料標記為「手動輸入」來源

#### 匯入 UI 需求

- CSV 檔案上傳
- 欄位對應介面（將 CSV 欄位對應到資料庫欄位）
- 匯入前預覽（顯示前 10 筆）
- 大檔案進度指示器
- 匯入摘要報告（成功/錯誤計數）
- 失敗列的錯誤日誌

---

## 未來增強功能（Sprint 2+）

### 交易匹配

**目的**：匹配預期的週期性支出與實際交易

**工作流程**:

1. 系統偵測到與週期性支出類似的交易
2. 建議自動匹配
3. 使用者確認或調整
4. 將交易連結至週期性支出
5. 從「意外支出」計算中移除

### 預算預測

**目的**：根據模式預測下個月的預算

**功能**:

- 季節性消費模式
- 週期性支出預測
- 收入穩定性分析
- 儲蓄目標追蹤

### 多幣別支援

**目的**：處理外幣交易手續費和匯率

**需求**:

- 儲存原始幣別和金額
- 追蹤交易時的匯率
- 計算新台幣等值
- 同時顯示兩種貨幣

### 收據附件

**目的**：儲存收據影像供報稅和保固用途

**功能**:

- 每筆交易可附加多張影像
- OCR 收據資料
- 以收據內容搜尋
- 匯出收據供報稅使用

### Apex 整合

**目的**：匯出交易資料供統計分析

**資料流**:

```
Flourish (transactions) → Apex (condition formulas) → Charts/Insights
```

**使用案例**:

- 財務健康評分
- 消費趨勢分析
- 分類最佳化建議
- 儲蓄目標進度追蹤

---

## 與原始計畫的主要差異

### 原始假設

- ❌ 每日手動輸入交易
- ❌ 即時分類
- ❌ 簡單的收支追蹤

### 實際需求

- ✅ 每月 PDF 帳單批次處理
- ✅ AI 驅動的交易辨識
- ✅ 預扣預算計算
- ✅ 多卡重度使用者工作流程
- ✅ 歷史資料遷移

### 架構影響

- **資料庫**：以帳單為中心的模型（非以交易為中心）
- **UI 流程**：上傳 → 檢視 → 匯入（非新增交易表單）
- **預算計算**：預扣系統（非簡單加總）
- **卡片管理**：使用中/停用狀態（非單一卡片假設）

---

## 成功指標

### Sprint 0.5 MVP 成功

- ✅ 上傳 PDF 帳單
- ✅ 提取基本交易資料（日期、金額、商家）
- ✅ 檢視並編輯提取的資料
- ✅ 匯入交易到資料庫
- ✅ 將交易連結至帳單
- ✅ 管理多張信用卡

### Sprint 2+ 成功

- ✅ 預扣預算計算
- ✅ 週期性支出管理
- ✅ 自動儲蓄規則
- ✅ 匯入歷史資料
- ✅ 交易匹配
- ✅ 預算預測

### 長期成功

- ⏱️ **節省時間**：30 分鐘/月 → 5 分鐘/月
- 📊 **準確度**：95%+ 交易辨識率
- 💰 **預算清晰度**：隨時知道實際可用金額
- 📈 **財務洞察**：清楚的消費模式和趨勢
- 🎯 **儲蓄目標**：自動執行儲蓄規則

---

## 相關文件

- [Database Design](../architecture/database-design.md)
- [Workflow Pivot Analysis](workflow-pivot-analysis.md)
- [Functional Requirements](functional-requirements.md)
- [Sprint 0.5 Requirements](../sprints/sprint-0.5-mvp/requirements.md)
