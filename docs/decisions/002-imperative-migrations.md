# ADR 002: ä½¿ç”¨ Imperative Migrations ç®¡ç†è³‡æ–™åº« Schema è®Šæ›´

**ç‹€æ…‹**: å·²æ¥å—
**æ—¥æœŸ**: 2025-11-13
**æ±ºç­–è€…**: Henry Lee
**ç›¸é—œæ–‡ä»¶**: [ADR 001 - æ¶æ§‹ç°¡åŒ–](./001-architecture-simplification.md)ã€[Sprint 9, Task 2](../sprints/sprint-0-foundation/09-supabase-migration-plan.md)

---

## èƒŒæ™¯è„ˆçµ¡

åœ¨ Sprint 9, Task 2ï¼ˆè³‡æ–™åº« Schema èˆ‡é·ç§»ï¼‰æœŸé–“ï¼Œæˆ‘å€‘éœ€è¦åœ¨å…©ç¨®ç®¡ç† Supabase è³‡æ–™åº«é·ç§»çš„æ–¹æ³•ä¹‹é–“åšé¸æ“‡ï¼š

1. **Imperative Migrationsï¼ˆå‘½ä»¤å¼é·ç§»ï¼‰** - å‚³çµ±çš„ SQL é·ç§»æª”æ¡ˆ
2. **Declarative Schemaï¼ˆå®£å‘Šå¼ Schemaï¼‰** - Supabase æ–°åŠŸèƒ½ï¼ˆ2024-2025ï¼‰ä½¿ç”¨ç‹€æ…‹å¼ schema å®šç¾©

å…©ç¨®æ–¹æ³•éƒ½æ˜¯ Supabase å®˜æ–¹æ”¯æ´ä¸”å·²å¯ç”¨æ–¼æ­£å¼ç’°å¢ƒã€‚

### èƒŒæ™¯èªªæ˜

- Flourish æ˜¯å€‹äººå°ˆæ¡ˆï¼Œç”±å–®ä¸€é–‹ç™¼è€…ï¼ˆHenryï¼‰è² è²¬
- å°ˆæ¡ˆä½¿ç”¨ Supabase ä½œç‚ºè³‡æ–™åº«èˆ‡å¾Œç«¯ï¼ˆä¾æ“š ADR 001ï¼‰
- Schema åŒ…å« 7 å€‹æ ¸å¿ƒè³‡æ–™è¡¨ï¼ˆusersã€cardsã€categoriesã€statementsã€transactionsã€recurring_expensesã€saving_rulesï¼‰
- é æœŸé·ç§»é »ç‡è¼ƒä½ï¼ˆæœ€å¤šæ¯æœˆä¸€æ¬¡ï¼‰
- é–‹ç™¼è€…ç›®æ¨™ï¼šæˆç‚ºå…·å‚™æ‰å¯¦ SQL çŸ¥è­˜çš„å…¨ç«¯å·¥ç¨‹å¸«

### ç ”ç©¶ç™¼ç¾

**Imperative Migrationsï¼ˆå‘½ä»¤å¼é·ç§»ï¼‰**ï¼š

- âœ… å®Œå…¨æŒæ§é·ç§»é‚è¼¯
- âœ… æ˜ç¢ºçš„æ­·å²è¨˜éŒ„èˆ‡æ¸…æ™°çš„å·®ç•°
- âœ… æ¨™æº– SQL - é€šç”¨çŸ¥è­˜
- âœ… å¯è™•ç†è¤‡é›œçš„è³‡æ–™è½‰æ›
- âŒ éœ€è¦æ‰‹å‹•ç·¨å¯« SQL
- âŒ æ²’æœ‰è‡ªå‹•åµæ¸¬ schema æ¼‚ç§»

**Declarative Schemaï¼ˆå®£å‘Šå¼ Schemaï¼‰**ï¼š

- âœ… é–‹ç™¼é€Ÿåº¦å¿« 70%ï¼ˆè‡ªå‹•ç”¢ç”Ÿé·ç§»ï¼‰
- âœ… è‡ªå‹•åµæ¸¬ schema æ¼‚ç§»
- âœ… ç°¡å–® CRUD æ“ä½œçš„å·¥ä½œæµç¨‹æ›´ç°¡å–®
- âŒ å°é·ç§»åŸ·è¡Œçš„æ§åˆ¶è¼ƒå°‘
- âŒ è¼ƒæ–°çš„åŠŸèƒ½ï¼Œå­¸ç¿’è³‡æºè¼ƒå°‘
- âŒ Supabase å°ˆå±¬ï¼Œä¸æ˜“ç§»æ¤

---

## æ±ºç­–

**æˆ‘å€‘å°‡ä½¿ç”¨ Imperative Migrationsï¼ˆSQL é·ç§»æª”æ¡ˆï¼‰ç®¡ç† Flourish çš„è³‡æ–™åº«ã€‚**

é·ç§»å·¥ä½œæµç¨‹ï¼š

```bash
# å»ºç«‹é·ç§»
npx supabase migration new feature_name

# ç·¨è¼¯ SQL æª”æ¡ˆ
# supabase/migrations/YYYYMMDDHHMMSS_feature_name.sql

# æ¨é€è‡³ Supabase
npx supabase db push
```

---

## ç†ç”±

### 1. å­¸ç¿’åƒ¹å€¼ï¼ˆä¸»è¦å› ç´ ï¼‰ğŸ“

**Henry çš„ç›®æ¨™**ï¼šæˆç‚ºå…¨ç«¯å·¥ç¨‹å¸«

- Imperative migrations æä¾›å¯¦éš›çš„ SQL ç·´ç¿’æ©Ÿæœƒ
- å»ºç«‹æ‰å¯¦çš„ SQL æŠ€èƒ½å°å¾Œç«¯é–‹ç™¼è‡³é—œé‡è¦
- Declarative Schema å°‡ SQL æŠ½è±¡åŒ–ï¼Œæ¸›å°‘å­¸ç¿’æ©Ÿæœƒ
- **å½±éŸ¿**ï¼šé«˜ - ç¬¦åˆå€‹äººç™¼å±•ç›®æ¨™

### 2. å°ˆæ¡ˆè¦æ¨¡ï¼ˆæ”¯æŒå› ç´ ï¼‰ğŸ“

**Flourish ç‰¹æ€§**ï¼š

- å–®ä¸€é–‹ç™¼è€…ï¼ˆç„¡åœ˜éšŠå”èª¿è¤‡é›œåº¦ï¼‰
- å°å‹ schemaï¼ˆ7 å€‹è³‡æ–™è¡¨ï¼Œç´„ 30 å€‹æ¬„ä½ï¼‰
- ä½é·ç§»é »ç‡ï¼ˆé ä¼°æ¯æœˆä¸€æ¬¡æˆ–æ›´å°‘ï¼‰

**åˆ†æ**ï¼š

- Declarative çš„ 70% é€Ÿåº¦å„ªå‹¢å°ä½é »è®Šæ›´å½±éŸ¿ä¸å¤§
- é ä¼°æ™‚é–“ç¯€çœï¼šæ¯å¹´ç´„ 2 å°æ™‚
- ä¸å€¼å¾—çŠ§ç‰²æ§åˆ¶æ¬Šèˆ‡å­¸ç¿’åƒ¹å€¼

### 3. å·²ç¶“å®Œæˆï¼ˆå‹™å¯¦å› ç´ ï¼‰âœ…

**ç›®å‰ç‹€æ…‹**ï¼š

- Sprint 9, Task 2 å·²å®Œæˆ 4 å€‹ Imperative migrations
- æ‰€æœ‰é·ç§»éƒ½å·²æ¸¬è©¦ä¸¦æˆåŠŸéƒ¨ç½²
- Schema åœ¨æ­£å¼ç’°å¢ƒä¸­æ­£å¸¸é‹ä½œ

**åˆ†æ**ï¼š

- åˆ‡æ›è‡³ Declarative éœ€è¦é‡æ–°å¯¦ä½œ
- ç›®å‰æ–¹æ³•æ²’æœ‰æŠ€è¡“å‚µå‹™
- é·ç§»æª”æ¡ˆå¯ä½œç‚ºå­¸ç¿’ç¯„ä¾‹

### 4. æ§åˆ¶èˆ‡å¯é æ¸¬æ€§ï¼ˆæŠ€è¡“å› ç´ ï¼‰ğŸ¯

**éœ€æ±‚**ï¼š

- éœ€è¦æ˜ç¢ºæ§åˆ¶ Row Level Securityï¼ˆRLSï¼‰ç­–ç•¥
- è¤‡é›œçš„è§¸ç™¼å™¨å‡½å¼ç”¨æ–¼èªè­‰æ•´åˆ
- æ¥­å‹™é‚è¼¯çš„è¼”åŠ©å‡½å¼
- è³‡æ–™å‹åˆ¥é·ç§»ï¼ˆPascalCase ENUM â†’ snake_caseï¼‰

**åˆ†æ**ï¼š

- Imperative æä¾›å°é·ç§»é †åºçš„å®Œå…¨æ§åˆ¶
- å¯åœ¨ pull requests ä¸­æª¢è¦–ç¢ºåˆ‡çš„ SQL
- æ²’æœ‰è‡ªå‹•ç”¢ç”Ÿç¨‹å¼ç¢¼çš„æ„å¤–é©šå–œ
- æ›´é©åˆè™•ç†è¤‡é›œæ“ä½œ

---

## å½±éŸ¿

### æ­£é¢å½±éŸ¿ âœ…

1. **æ‰å¯¦çš„ SQL åŸºç¤**ï¼šé–‹ç™¼è€…ç²å¾—å¯¶è²´çš„ SQL å°ˆæ¥­çŸ¥è­˜
2. **å®Œå…¨æ§åˆ¶**ï¼šå¯ä¾éœ€æ±‚å¯¦ä½œè¤‡é›œé·ç§»
3. **æ¸…æ™°çš„æ­·å²**ï¼šæ¯å€‹é·ç§»æª”æ¡ˆéƒ½è¨˜éŒ„ç¢ºåˆ‡çš„è®Šæ›´
4. **æ˜“æ–¼å¯©æŸ¥**ï¼šSQL å·®ç•°åœ¨ PRs ä¸­ä¸€ç›®äº†ç„¶
5. **å¯ç§»æ¤çš„çŸ¥è­˜**ï¼šSQL æŠ€èƒ½å¯æ‡‰ç”¨æ–¼ä»»ä½•è³‡æ–™åº«/ORM

### è² é¢å½±éŸ¿ âŒ

1. **æ‰‹å‹•å·¥ä½œ**ï¼šæ¯æ¬¡è®Šæ›´éƒ½å¿…é ˆæ‰‹å¯« SQL
2. **æ²’æœ‰è‡ªå‹•å·®ç•°æ¯”å°**ï¼šç„¡æ³•è‡ªå‹•åµæ¸¬ schema æ¼‚ç§»
3. **ç¨æ…¢ï¼ˆé‚Šéš›ï¼‰**ï¼šæ’°å¯«é·ç§»æ¯”è‡ªå‹•ç”¢ç”Ÿè€—æ™‚

### ä¸­æ€§å½±éŸ¿ ğŸŸ¡

1. **å¯ä»¥ä¹‹å¾Œåˆ‡æ›**ï¼šæœªä¾†å¦‚æœéœ€æ±‚æ”¹è®Šï¼Œä»å¯é·ç§»è‡³ Declarative Schema
2. **å…©ç¨®æ–¹æ³•éƒ½å—æ”¯æ´**ï¼šSupabase é•·æœŸç¶­è­·å…©è€…

---

## è€ƒæ…®éçš„æ›¿ä»£æ–¹æ¡ˆ

### æ›¿ä»£æ–¹æ¡ˆ 1ï¼šDeclarative Schema

**å„ªé»**ï¼š

- é–‹ç™¼é€Ÿåº¦å¿«ï¼ˆç¯€çœ 70% æ™‚é–“ï¼‰
- è‡ªå‹•åµæ¸¬æ¼‚ç§»
- å·¥ä½œæµç¨‹æ›´ç°¡å–®

**ç¼ºé»**ï¼š

- å­¸ç¿’åƒ¹å€¼è¼ƒä½ï¼ˆå°‡ SQL æŠ½è±¡åŒ–ï¼‰
- å°é·ç§»çš„æ§åˆ¶è¼ƒå°‘
- å¯ç”¨çš„å­¸ç¿’è³‡æºè¼ƒå°‘

**ç‚ºä½•æ‹’çµ•**ï¼šå°æ­¤å°ˆæ¡ˆè€Œè¨€ï¼Œå­¸ç¿’åƒ¹å€¼èˆ‡æ§åˆ¶æ¬Šçš„å„ªå…ˆç´šé«˜æ–¼é€Ÿåº¦ã€‚

### æ›¿ä»£æ–¹æ¡ˆ 2ï¼šåŸºæ–¼ ORM çš„é·ç§»ï¼ˆPrismaã€Drizzleï¼‰

**å„ªé»**ï¼š

- TypeScript å„ªå…ˆæ–¹æ³•
- å‹åˆ¥å®‰å…¨æŸ¥è©¢
- æ•´åˆé·ç§»

**ç¼ºé»**ï¼š

- Supabase æ•´åˆä¸ä½³ï¼ˆæ ¹æ“š ADR 001 ç ”ç©¶ï¼‰
- ä¸æ”¯æ´ Supabase åŠŸèƒ½ï¼ˆRLSã€auth.usersã€è§¸ç™¼å™¨ï¼‰
- é¡å¤–çš„æŠ½è±¡å±¤

**ç‚ºä½•æ‹’çµ•**ï¼šADR 001 å·²æ±ºå®šä¸ä½¿ç”¨ ORMï¼Œå›  Supabase ç›¸å®¹æ€§å•é¡Œã€‚

### æ›¿ä»£æ–¹æ¡ˆ 3ï¼šæ··åˆæ–¹æ³•

**æƒ³æ³•**ï¼šè¤‡é›œé·ç§»ä½¿ç”¨ Imperativeï¼Œç°¡å–®é·ç§»ä½¿ç”¨ Declarative

**ç‚ºä½•æ‹’çµ•**ï¼šæ··åˆæ–¹æ³•æœƒé€ æˆä¸ä¸€è‡´èˆ‡å›°æƒ‘ã€‚

---

## å¯¦ä½œ

### Sprint 9, Task 2 äº¤ä»˜æˆæœ

ä½¿ç”¨ Imperative æ–¹æ³•å®Œæˆ 4 å€‹é·ç§»ï¼š

1. **`20251113050233_initial_schema.sql`**
   - æ ¸å¿ƒè³‡æ–™è¡¨èˆ‡ ENUM å‹åˆ¥
   - å¤–éµé—œè¯
   - æ™‚é–“æˆ³èˆ‡é è¨­å€¼

2. **`20251113054218_auth_integration.sql`**
   - è‡ªå‹•å»ºç«‹ä½¿ç”¨è€…è§¸ç™¼å™¨
   - æ‰€æœ‰è³‡æ–™è¡¨çš„ updated_at è§¸ç™¼å™¨

3. **`20251113054418_rls_policies.sql`**
   - å•Ÿç”¨ Row Level Security
   - ä½¿ç”¨è€…è³‡æ–™éš”é›¢ç­–ç•¥

4. **`20251113054900_indexes_functions.sql`**
   - æ•ˆèƒ½ç´¢å¼•
   - æ¥­å‹™é‚è¼¯çš„è¼”åŠ©å‡½å¼

### æœªä¾†é·ç§»æŒ‡å—

```sql
-- æ–°é·ç§»çš„ç¯„æœ¬
-- supabase/migrations/YYYYMMDDHHMMSS_descriptive_name.sql

-- ============================================================================
-- Migration XX: æè¿°æ€§æ¨™é¡Œ
-- ç›®çš„èˆ‡èƒŒæ™¯èªªæ˜
-- ============================================================================

-- åœ¨æ­¤åŠ å…¥ä½ çš„ SQL
-- ä½¿ç”¨è¨»è§£èªªæ˜éé¡¯è€Œæ˜“è¦‹çš„é‚è¼¯

-- æ–°å¢è³‡æ–™è¡¨è¨»è§£ä½œç‚ºæ–‡æª”
COMMENT ON TABLE table_name IS 'ç›®çš„æè¿°';
COMMENT ON COLUMN table_name.column_name IS 'ç”¨é€”æè¿°';
```

---

## é‡æ–°å¯©è¦–è§¸ç™¼æ¢ä»¶

å¦‚æœå‡ºç¾ä»¥ä¸‹æƒ…æ³ï¼Œè«‹é‡æ–°è€ƒæ…®æ­¤æ±ºç­–ï¼š

1. **åœ˜éšŠæˆé•·**ï¼šå¤šä½é–‹ç™¼è€…åŠ å…¥ â†’ Declarative å¯èƒ½ç°¡åŒ–å”ä½œ
2. **é«˜é »ç‡**ï¼šSchema è®Šæ›´è®Šæˆæ¯é€± â†’ 70% é€Ÿåº¦ç¯€çœè®Šå¾—é¡¯è‘—
3. **SQL ç²¾é€š**ï¼šHenry é”æˆæ‰å¯¦çš„ SQL æŠ€èƒ½ â†’ å­¸ç¿’åƒ¹å€¼å·²é”æˆ
4. **Schema è¤‡é›œåº¦**ï¼šSchema æˆé•·è‡³ 50+ è³‡æ–™è¡¨ â†’ è‡ªå‹•å·®ç•°æ¯”å°è®Šå¾—æœ‰åƒ¹å€¼
5. **æ¼‚ç§»å•é¡Œ**ï¼šæ‰‹å‹•ç®¡ç†æ¼‚ç§»è®Šå¾—ç—›è‹¦ â†’ éœ€è¦è‡ªå‹•åµæ¸¬

**ä¸‹æ¬¡å¯©æŸ¥**ï¼šSprint 1ï¼ˆèªè­‰ï¼‰ä¹‹å¾Œï¼Œç•¶ schema æ¼”åŒ–æ¨¡å¼è®Šå¾—æ›´æ¸…æ™°æ™‚

---

## ç›¸é—œæ±ºç­–

- **ADR 001 - æ¶æ§‹ç°¡åŒ–**ï¼šæ±ºå®šç›´æ¥ä½¿ç”¨ Supabaseï¼ˆç„¡ NestJSã€ç„¡ Prismaï¼‰
- æœ¬ ADR è£œå…… ADR 001ï¼Œå®šç¾©æˆ‘å€‘å¦‚ä½•ç®¡ç† Supabase é·ç§»

---

## åƒè€ƒè³‡æº

- [Supabase é·ç§»æ–¹æ³•æŒ‡å—](../guides/supabase-migration-approaches.md) - è©³ç´°æ¯”è¼ƒ
- [Supabase CLI æ–‡æª”](https://supabase.com/docs/guides/cli)
- [Sprint 9, Task 2 å¯¦ä½œ](../sprints/sprint-0-foundation/09-supabase-migration-plan.md)
- [PostgreSQL é·ç§»æœ€ä½³å¯¦è¸](https://www.postgresql.org/docs/current/ddl-alter.html)

---

## å‚™è¨»

### ç‚ºä»€éº¼é€™å¾ˆé‡è¦

è³‡æ–™åº«é·ç§»æ˜¯å½±éŸ¿ä»¥ä¸‹æ–¹é¢çš„åŸºç¤æ±ºç­–ï¼š

- é–‹ç™¼é€Ÿåº¦
- ç¨‹å¼ç¢¼å¯©æŸ¥å“è³ª
- åœ˜éšŠæ–°äººä¸Šæ‰‹
- æŠ€è¡“å‚µå‹™ç´¯ç©
- é–‹ç™¼è€…æŠ€èƒ½æˆé•·

é¸æ“‡ Imperative Migrations å„ªå…ˆè€ƒæ…®**å­¸ç¿’èˆ‡æ§åˆ¶**è€Œé**é€Ÿåº¦èˆ‡ä¾¿åˆ©** - é©åˆæ­£åœ¨å»ºç«‹å…¨ç«¯æŠ€èƒ½çš„å–®ä¸€é–‹ç™¼è€…ã€‚

### æœªä¾†çš„é·ç§»è·¯å¾‘

å¦‚æœä¹‹å¾Œåˆ‡æ›è‡³ Declarative Schemaï¼š

```bash
# å¾ç¾æœ‰é·ç§»ç”¢ç”Ÿ schema.sql
npx supabase db dump --schema public > supabase/schema.sql

# æœªä¾†è®Šæ›´ç·¨è¼¯ schema.sql ä¸¦åŸ·è¡Œ
npx supabase db diff
```

ç¾æœ‰çš„ Imperative migrations ä»ç„¶æœ‰æ•ˆä¸”å¯é‹ä½œã€‚
