# Sprint 0.9: Supabase Migration Plan

**Status**: ‚úÖ COMPLETED (Planning Phase)
**Date**: 2025-11-12
**Total Duration**: ~9.5 hours (split across 4 sub-sprints)
**Architecture**: Pure Supabase (ADR 001)

---

## üìã Executive Summary

This document outlines the comprehensive plan to migrate from NestJS + Render to pure Supabase architecture. The migration is broken into 4 manageable sub-sprints (0.9.1-0.9.4), each with clear objectives, deliverables, and success criteria.

**Key Metrics:**

- Cost Reduction: 100% ($7+/month ‚Üí $0/month)
- Maintenance Reduction: ~70%
- Development Speed: ~60% faster
- Total Implementation Time: ~9.5 hours

---

## üéØ Project Overview

### Current Status (Sprint 0.8 Complete)

‚úÖ **Phase 0: Foundation (100% Complete)**

- Monorepo structure established
- Development tooling configured
- NestJS backend created and tested
- Apex frontend foundation ready
- Architecture decision made (ADR 001)

### Migration Objective

Simplify architecture by removing the independent NestJS API layer and leveraging Supabase's built-in capabilities:

```
BEFORE:
Frontend (Flow/Apex) ‚Üí NestJS API ‚Üí Supabase Database
         ‚Üì                  ‚Üì
     Vercel             Render ($7/month)

AFTER:
Frontend (Flow/Apex) ‚Üí Supabase (Database + Auth + REST API)
         ‚Üì
     Vercel ($0 backend cost)
```

### Why This Approach?

From **ADR 001 - Architecture Simplification**:

1. **Perfect Feature Fit**: Flourish's core needs (CRUD + statistics) are standard operations Supabase excels at
2. **Cost**: Free tier covers current requirements ($0 vs $7+/month)
3. **Maintenance**: No separate API infrastructure to manage
4. **Development Speed**: Auto-generated REST API eliminates manual endpoint creation
5. **Scalability**: Can upgrade to Supabase paid tier or add Edge Functions if needed

---

## üìä Sub-Sprint Structure

### Sprint 0.9.1: Supabase Basic Setup ‚è±Ô∏è ~2 hours

**Objective**: Initialize Supabase development environment and verify MCP integration

**Dependencies**: None (first sprint)

#### 1.1 Supabase CLI Authentication

```bash
# Login to Supabase (opens browser for OAuth)
npx supabase login
```

**Deliverable**: Authenticated CLI session with Supabase account

#### 1.2 Project Initialization & Linking

```bash
# Initialize Supabase configuration
npx supabase init

# Link to remote project
npx supabase link --project-ref fstcioczrehqtcbdzuij

# Verify connection
npx supabase status
```

**Expected Output**:

```
Supabase CLI version: X.X.X
Project: fstcioczrehqtcbdzuij
API URL: https://fstcioczrehqtcbdzuij.supabase.co
JWT Secret: [configured]
```

**Deliverable**:

- `supabase/config.toml` created
- Project successfully linked

#### 1.3 Environment Variables Setup

**File**: `.env.local` (root directory)

```bash
# Supabase Project Configuration
SUPABASE_PROJECT_REF=fstcioczrehqtcbdzuij
SUPABASE_ACCESS_TOKEN=<your-access-token>

# Frontend Keys (from Supabase Dashboard ‚Üí Settings ‚Üí API)
NEXT_PUBLIC_SUPABASE_URL=https://fstcioczrehqtcbdzuij.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=<your-anon-key>

# MCP Configuration (uses token above)
# .claude/mcp-settings.json references ${SUPABASE_ACCESS_TOKEN}
```

**Deliverable**: All environment variables configured locally

#### 1.4 MCP Configuration & Testing

**File**: `.claude/mcp-settings.json` (already created)

```json
{
  "mcpServers": {
    "supabase": {
      "command": "npx",
      "args": ["-y", "@supabase/mcp-server"],
      "env": {
        "SUPABASE_ACCESS_TOKEN": "${SUPABASE_ACCESS_TOKEN}",
        "SUPABASE_PROJECT_REF": "fstcioczrehqtcbdzuij"
      }
    }
  }
}
```

**Test Steps**:

1. Restart Claude Code
2. Check available tools (should see `mcp__supabase__*` tools)
3. Test basic Supabase query via MCP
4. Verify access to project information

**Deliverable**: MCP tools available and functional

#### 1.5 API Keys Retrieval

From Supabase Dashboard:

1. Navigate to Settings ‚Üí API
2. Copy `Project URL` and `Anon Key`
3. Add to `.env.local`

**Deliverable**: All keys configured in environment

### Verification Checklist (Sprint 0.9.1)

- [ ] `npx supabase status` returns project info
- [ ] `.env.local` contains all required variables
- [ ] `.claude/mcp-settings.json` created with env variables
- [ ] Claude Code restarted and MCP tools visible
- [ ] MCP can query Supabase project
- [ ] No hardcoded tokens in config files (only env placeholders)

**Success Criteria**: Supabase environment ready, MCP tools functional

---

### Sprint 0.9.2: Database Migrations ‚è±Ô∏è ~2.5 hours

**Objective**: Create and execute SQL migrations to establish complete database schema

**Dependencies**: Sprint 0.9.1 (Supabase linked)

**Pre-requisites**:

- Prisma schema reference available: `packages/database/prisma/schema.prisma`
- Migration templates documented below

#### 2.1 Migration Structure

Create 4 migration files in `supabase/migrations/`:

```
supabase/migrations/
‚îú‚îÄ‚îÄ 20241112000000_initial_schema.sql
‚îú‚îÄ‚îÄ 20241112000001_auth_integration.sql
‚îú‚îÄ‚îÄ 20241112000002_rls_policies.sql
‚îî‚îÄ‚îÄ 20241112000003_indexes_functions.sql
```

Each migration builds on the previous one.

#### 2.2 Migration 01: Initial Schema

**File**: `20241112000000_initial_schema.sql`

Contains all core tables:

```sql
-- Create ENUM types first
CREATE TYPE statement_status AS ENUM ('PENDING', 'EXTRACTED', 'IMPORTED', 'ARCHIVED');
CREATE TYPE transaction_type AS ENUM ('EXPENSE', 'INCOME', 'REFUND');
CREATE TYPE recurring_frequency AS ENUM ('WEEKLY', 'BIWEEKLY', 'MONTHLY', 'QUARTERLY', 'BIANNUAL', 'ANNUAL');

-- Users table (linked to Supabase auth)
CREATE TABLE users (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT UNIQUE NOT NULL,
  name TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Cards table
CREATE TABLE cards (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  bank TEXT NOT NULL,
  last4 TEXT NOT NULL,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, last4)
);

-- Categories table
CREATE TABLE categories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  color TEXT DEFAULT '#808080',
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, name)
);

-- Statements table
CREATE TABLE statements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  card_id UUID NOT NULL REFERENCES cards(id) ON DELETE RESTRICT,
  pdf_url TEXT,
  upload_date TIMESTAMPTZ DEFAULT NOW(),
  statement_date TIMESTAMPTZ NOT NULL,
  status statement_status DEFAULT 'PENDING',
  extracted_count INTEGER DEFAULT 0,
  imported_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Transactions table
CREATE TABLE transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  statement_id UUID REFERENCES statements(id) ON DELETE SET NULL,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  category_id UUID REFERENCES categories(id) ON DELETE SET NULL,
  merchant_name TEXT NOT NULL,
  description TEXT,
  amount DECIMAL(12, 2) NOT NULL,
  type transaction_type NOT NULL,
  date TIMESTAMPTZ NOT NULL,
  confidence FLOAT,
  raw_text TEXT,
  is_manual_entry BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Recurring Expenses table
CREATE TABLE recurring_expenses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  category_id UUID REFERENCES categories(id) ON DELETE SET NULL,
  name TEXT NOT NULL,
  description TEXT,
  amount DECIMAL(12, 2) NOT NULL,
  frequency recurring_frequency NOT NULL,
  start_date TIMESTAMPTZ NOT NULL,
  end_date TIMESTAMPTZ,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Saving Rules table
CREATE TABLE saving_rules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  amount DECIMAL(12, 2) NOT NULL,
  frequency TEXT NOT NULL,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### 2.3 Migration 02: Auth Integration

**File**: `20241112000001_auth_integration.sql`

Sets up automatic user creation and updated_at triggers:

```sql
-- Auto-create user record when auth.users is created
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.users (id, email, name)
  VALUES (NEW.id, NEW.email, NEW.raw_user_meta_data->>'name');
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION handle_new_user();

-- Updated_at trigger function
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Apply to all tables
CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_cards_updated_at BEFORE UPDATE ON cards
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_categories_updated_at BEFORE UPDATE ON categories
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_statements_updated_at BEFORE UPDATE ON statements
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_transactions_updated_at BEFORE UPDATE ON transactions
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_recurring_expenses_updated_at BEFORE UPDATE ON recurring_expenses
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_saving_rules_updated_at BEFORE UPDATE ON saving_rules
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

#### 2.4 Migration 03: Row Level Security

**File**: `20241112000002_rls_policies.sql`

Enables RLS and creates user-isolation policies:

```sql
-- Enable RLS on all tables
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE cards ENABLE ROW LEVEL SECURITY;
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE statements ENABLE ROW LEVEL SECURITY;
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE recurring_expenses ENABLE ROW LEVEL SECURITY;
ALTER TABLE saving_rules ENABLE ROW LEVEL SECURITY;

-- Users: Can view and update own profile
CREATE POLICY "Users can view own profile" ON users
  FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update own profile" ON users
  FOR UPDATE USING (auth.uid() = id);

-- Cards: User isolation
CREATE POLICY "Users can view own cards" ON cards
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can manage own cards" ON cards
  USING (auth.uid() = user_id);

-- Categories: User isolation
CREATE POLICY "Users can manage own categories" ON categories
  USING (auth.uid() = user_id);

-- Statements: User isolation
CREATE POLICY "Users can manage own statements" ON statements
  USING (auth.uid() = user_id);

-- Transactions: User isolation
CREATE POLICY "Users can manage own transactions" ON transactions
  USING (auth.uid() = user_id);

-- Recurring Expenses: User isolation
CREATE POLICY "Users can manage own recurring expenses" ON recurring_expenses
  USING (auth.uid() = user_id);

-- Saving Rules: User isolation
CREATE POLICY "Users can manage own saving rules" ON saving_rules
  USING (auth.uid() = user_id);
```

#### 2.5 Migration 04: Indexes & Functions

**File**: `20241112000003_indexes_functions.sql`

Performance optimization and helper functions:

```sql
-- Performance indexes
CREATE INDEX idx_statements_user_card ON statements(user_id, card_id);
CREATE INDEX idx_statements_date ON statements(statement_date);
CREATE INDEX idx_transactions_user_date ON transactions(user_id, date);
CREATE INDEX idx_transactions_statement ON transactions(statement_id);
CREATE INDEX idx_transactions_category ON transactions(category_id);
CREATE INDEX idx_recurring_expenses_user ON recurring_expenses(user_id);
CREATE INDEX idx_saving_rules_user ON saving_rules(user_id);

-- Helper function: Monthly spending total
CREATE OR REPLACE FUNCTION get_monthly_spending(
  p_user_id UUID,
  p_year INTEGER,
  p_month INTEGER
)
RETURNS DECIMAL AS $$
  SELECT COALESCE(SUM(amount), 0)
  FROM transactions
  WHERE user_id = p_user_id
    AND type = 'EXPENSE'
    AND EXTRACT(YEAR FROM date) = p_year
    AND EXTRACT(MONTH FROM date) = p_month;
$$ LANGUAGE SQL STABLE;

-- Helper function: Total by category
CREATE OR REPLACE FUNCTION get_category_total(
  p_user_id UUID,
  p_category_id UUID
)
RETURNS DECIMAL AS $$
  SELECT COALESCE(SUM(amount), 0)
  FROM transactions
  WHERE user_id = p_user_id
    AND category_id = p_category_id
    AND type = 'EXPENSE';
$$ LANGUAGE SQL STABLE;
```

#### 2.6 Execute Migrations

**Local Testing**:

```bash
# Reset local database with all migrations
npx supabase db reset

# Should output: "Database reset successful"
```

**Deploy to Remote**:

```bash
# Push to remote Supabase project
npx supabase db push

# Verify with
npx supabase db diff
```

**Expected Output**: All migrations applied successfully

### Verification Checklist (Sprint 0.9.2)

- [ ] All 4 migration files created and error-free
- [ ] Local `supabase db reset` runs successfully
- [ ] All tables exist and have correct schema
- [ ] Auth triggers work (test user creation)
- [ ] RLS policies enabled on all tables
- [ ] Performance indexes created
- [ ] Helper functions exist and callable
- [ ] Remote push succeeds (`npx supabase db push`)
- [ ] Can query via SQL editor in Supabase Dashboard

**Success Criteria**: Complete database schema with RLS and triggers functioning

---

### Sprint 0.9.3: Client Package & Integration ‚è±Ô∏è ~3.5 hours

**Objective**: Create Supabase client package and integrate into Flow/Apex

**Dependencies**: Sprint 0.9.2 (Database ready)

#### 3.1 Create supabase-client Package

```bash
mkdir -p packages/supabase-client/{src,src/hooks}
cd packages/supabase-client
touch package.json tsconfig.json src/index.ts src/client.ts src/types.ts
```

#### 3.2 Package Configuration

**File**: `packages/supabase-client/package.json`

```json
{
  "name": "@repo/supabase-client",
  "version": "0.1.0",
  "private": true,
  "main": "./src/index.ts",
  "types": "./src/index.ts",
  "scripts": {
    "generate-types": "npx supabase gen types typescript --project-id fstcioczrehqtcbdzuij > src/types.ts",
    "lint": "eslint .",
    "check-types": "tsc --noEmit"
  },
  "dependencies": {
    "@supabase/supabase-js": "^2.39.0"
  },
  "devDependencies": {
    "@repo/typescript-config": "workspace:*",
    "@repo/eslint-config": "workspace:*",
    "typescript": "5.9.2"
  }
}
```

#### 3.3 TypeScript Configuration

**File**: `packages/supabase-client/tsconfig.json`

```json
{
  "extends": "@repo/typescript-config/react.json",
  "compilerOptions": {
    "outDir": "./dist"
  },
  "include": ["src"],
  "exclude": ["node_modules"]
}
```

#### 3.4 Client Initialization

**File**: `packages/supabase-client/src/client.ts`

```typescript
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error('Missing Supabase environment variables');
}

export const supabase = createClient<Database>(supabaseUrl, supabaseAnonKey, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
  },
});

export type SupabaseClient = typeof supabase;
```

#### 3.5 Generate TypeScript Types

```bash
cd packages/supabase-client
pnpm generate-types
```

This auto-generates `src/types.ts` with full typing for your database schema.

#### 3.6 Create React Hooks

**File**: `packages/supabase-client/src/hooks/useAuth.ts`

```typescript
import { useState, useEffect } from 'react';
import { supabase } from '../client';
import type { User } from '@supabase/supabase-js';

export function useAuth() {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);

  useEffect(() => {
    // Get initial session
    supabase.auth.getSession().then(({ data, error }) => {
      if (error) setError(error);
      setUser(data?.session?.user ?? null);
      setLoading(false);
    });

    // Listen for auth changes
    const { data: authListener } = supabase.auth.onAuthStateChange((event, session) => {
      setUser(session?.user ?? null);
    });

    return () => {
      authListener?.subscription.unsubscribe();
    };
  }, []);

  return { user, loading, error };
}
```

**File**: `packages/supabase-client/src/hooks/useTransactions.ts`

```typescript
import { useState, useEffect } from 'react';
import { supabase } from '../client';
import type { Database } from '../types';

type Transaction = Database['public']['Tables']['transactions']['Row'];

export function useTransactions(userId: string | null) {
  const [transactions, setTransactions] = useState<Transaction[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);

  useEffect(() => {
    if (!userId) {
      setTransactions([]);
      setLoading(false);
      return;
    }

    async function fetchTransactions() {
      try {
        const { data, error } = await supabase
          .from('transactions')
          .select('*')
          .eq('user_id', userId)
          .order('date', { ascending: false });

        if (error) throw error;
        setTransactions(data || []);
      } catch (err) {
        setError(err as Error);
      } finally {
        setLoading(false);
      }
    }

    fetchTransactions();
  }, [userId]);

  return { transactions, loading, error };
}
```

#### 3.7 Export Index

**File**: `packages/supabase-client/src/index.ts`

```typescript
export { supabase, type SupabaseClient } from './client';
export * from './types';
export { useAuth } from './hooks/useAuth';
export { useTransactions } from './hooks/useTransactions';
```

#### 3.8 Integrate into Flow App

**File**: `apps/flow/package.json`

Add dependency:

```json
{
  "dependencies": {
    "@repo/supabase-client": "workspace:*"
  }
}
```

**File**: `apps/flow/.env.local`

```bash
NEXT_PUBLIC_SUPABASE_URL=https://fstcioczrehqtcbdzuij.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=<your-anon-key>
```

**Example Usage** in `apps/flow/app/transactions/page.tsx`:

```typescript
'use client';

import { useAuth, useTransactions } from '@repo/supabase-client';

export default function TransactionsPage() {
  const { user, loading: authLoading } = useAuth();
  const { transactions, loading } = useTransactions(user?.id || null);

  if (authLoading || loading) return <div>Loading...</div>;
  if (!user) return <div>Please login first</div>;

  return (
    <div>
      <h1>Transactions</h1>
      {transactions.length === 0 ? (
        <p>No transactions yet</p>
      ) : (
        <ul>
          {transactions.map((tx) => (
            <li key={tx.id}>
              {tx.merchant_name} - ${tx.amount} ({tx.type})
            </li>
          ))}
        </ul>
      )}
    </div>
  );
}
```

#### 3.9 Integrate into Apex App

Same process as Flow:

1. Add `@repo/supabase-client` dependency
2. Configure `.env.local` with Supabase keys
3. Use hooks in components

### Verification Checklist (Sprint 0.9.3)

- [ ] `packages/supabase-client/` package created
- [ ] `pnpm install` succeeds
- [ ] `pnpm generate-types` creates `src/types.ts` without errors
- [ ] All hooks compile without TypeScript errors
- [ ] Flow app dependency added and resolved
- [ ] Apex app dependency added and resolved
- [ ] Both apps can run with `pnpm dev`
- [ ] Can import from `@repo/supabase-client` in both apps
- [ ] Sample transaction query works (returns empty array initially)

**Success Criteria**: Frontend can connect and query Supabase

---

### Sprint 0.9.4: Cleanup & Documentation ‚è±Ô∏è ~1.5 hours

**Objective**: Archive NestJS API and complete all documentation

**Dependencies**: Sprint 0.9.3 (Integration complete)

#### 4.1 Archive NestJS API

```bash
# Record last commit
git log --oneline apps/api/ -1 > docs/archive/nestjs-api/last-commit.txt

# Remove from version control
git rm -r apps/api/

# Update turbo.json (remove api references)
# Remove these from turbo.json:
# - "api" from workspace packages
# - Any api-specific task configs
```

#### 4.2 Create Archive Documentation

**File**: `docs/archive/nestjs-api/README.md`

```markdown
# NestJS API Archive

**Archive Date**: 2025-11-12
**Reason**: Migrated to Supabase architecture (ADR 001)
**Status**: No longer actively maintained

## What Was This?

The NestJS API (`apps/api/`) was a backend service that:

- Provided REST endpoints for Flow and Apex
- Managed database operations via Prisma
- Handled health checks and monitoring
- Ran on port 6888

## Why Was It Removed?

Supabase provides:

- Auto-generated REST API (from database schema)
- Built-in authentication
- Row Level Security for data protection
- Realtime subscriptions (future)
- 100% lower hosting cost ($0 vs $7+/month)

## If You Need This Later

All code is available in Git history:

- Last commit: [See last-commit.txt]
- Branch: `main` (before Sprint 0.9.1)
- Full deployment docs: `docs/archive/render-deployment/`

You can restore the code and use it as a microservice template if needed.
```

#### 4.3 Update Overview.md

**File**: `docs/sprints/sprint-0-foundation/overview.md`

Update the Sprint 0.9 section to show completion:

```markdown
### Sprint 0.9: Supabase Migration

**Time**: ~9.5 hours
**Status**: ‚úÖ COMPLETED

**What was done**:

#### Planning Phase (Completed)

- ‚úÖ Created comprehensive migration plan (this document)
- ‚úÖ Defined 4 sub-sprints with clear objectives
- ‚úÖ Set up secure MCP configuration
- ‚úÖ Documented all technical steps

#### Sprint 0.9.1: Supabase Setup (~2 hours)

- ‚úÖ Supabase CLI authentication
- ‚úÖ Project initialization and linking
- ‚úÖ Environment variables configuration
- ‚úÖ MCP integration and testing

#### Sprint 0.9.2: Database Migrations (~2.5 hours)

- ‚úÖ Created 4 SQL migration files
- ‚úÖ Implemented auth integration with triggers
- ‚úÖ Configured Row Level Security policies
- ‚úÖ Added performance indexes and helper functions

#### Sprint 0.9.3: Client & Integration (~3.5 hours)

- ‚úÖ Created `@repo/supabase-client` package
- ‚úÖ Generated TypeScript types from schema
- ‚úÖ Implemented React hooks (useAuth, useTransactions)
- ‚úÖ Integrated into Flow and Apex apps

#### Sprint 0.9.4: Cleanup & Docs (~1.5 hours)

- ‚úÖ Archived NestJS API
- ‚úÖ Updated Turbo configuration
- ‚úÖ Created archive documentation
- ‚úÖ Completed all sprint documentation

**Key Achievements**:

- ‚úÖ Pure Supabase architecture fully implemented
- ‚úÖ 100% cost reduction on backend
- ‚úÖ Frontend apps can query database directly
- ‚úÖ Type-safe database access in TypeScript
- ‚úÖ Ready for Sprint 1 (Authentication)

**Lessons Learned**:

- Breaking large sprints into smaller sub-sprints improves execution
- MCP setup requires careful environment variable management
- Supabase's auto-generated REST API eliminates significant API layer development
- TypeScript type generation from database schema is powerful

**Next**: Sprint 1 - Authentication System
```

#### 4.4 Create Comprehensive Documentation

**File**: `docs/guides/mcp-setup.md` (see separate section below)

**File**: `docs/guides/database-migrations.md`

Create a guide for future migrations:

````markdown
# Database Migrations Guide

## Workflow for Adding New Features

### 1. Design Phase

- Sketch new tables/columns
- Reference existing schema in `packages/database/prisma/schema.prisma`
- Consider RLS requirements

### 2. Create Migration

```bash
npx supabase migration new feature_name
```
````

This creates: `supabase/migrations/[timestamp]_feature_name.sql`

### 3. Write SQL

- Create tables/columns
- Add appropriate indexes
- Don't forget RLS policies if new table
- Test column permissions

### 4. Test Locally

```bash
npx supabase db reset  # Reset with all migrations
npx supabase db push   # Push to staging remote
```

### 5. Deploy

```bash
npx supabase db push  # Push to production
```

## RLS Policies Template

When adding a new table that should be user-specific:

```sql
ALTER TABLE new_table ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage own records" ON new_table
  USING (auth.uid() = user_id);
```

## Reverting Migrations

```bash
# View migration history
npx supabase migration list

# Rollback locally
npx supabase db reset
```

Note: Production rollbacks require manual Supabase Dashboard intervention

```

### Verification Checklist (Sprint 0.9.4)

- [ ] `apps/api/` removed from Git
- [ ] `turbo.json` updated (no api references)
- [ ] `docs/archive/nestjs-api/README.md` created
- [ ] `overview.md` updated with completion details
- [ ] `mcp-setup.md` created and complete
- [ ] `database-migrations.md` created
- [ ] All docs link to each other appropriately
- [ ] No broken documentation links

**Success Criteria**: Sprint 0.9 fully documented and archived

---

## üîÄ Dependency Flow

```

Sprint 0.9.1 (Setup)
‚Üì
Sprint 0.9.2 (Migrations) [depends on 0.9.1]
‚Üì
Sprint 0.9.3 (Integration) [depends on 0.9.2]
‚Üì
Sprint 0.9.4 (Cleanup) [depends on 0.9.3]

```

**Each sprint can only start after previous is complete**

---

## üö® Risk Assessment & Mitigation

### Risk 1: Migration SQL Errors

**Probability**: Medium
**Impact**: High (database unusable)

**Mitigation**:
- Test locally first with `supabase db reset`
- Review each migration before pushing
- Keep rollback procedures documented
- Push one migration at a time, verify before next

### Risk 2: RLS Policies Too Restrictive

**Probability**: Medium
**Impact**: Medium (features broken)

**Mitigation**:
- Test policies in Supabase SQL editor
- Use impersonation feature to test as different users
- Have policy relaxation plan ready
- Start restrictive, expand if needed

### Risk 3: MCP Unavailable

**Probability**: Low
**Impact**: Low (only affects AI assistance)

**Mitigation**:
- Can continue using Supabase CLI instead
- MCP is optional for implementation
- Not critical to project success

### Risk 4: Auth Integration Issues

**Probability**: Low
**Impact**: High (users can't login)

**Mitigation**:
- Test user creation flow thoroughly
- Verify trigger fires correctly
- Have backup manual user creation query
- Consider soft-launch with test accounts

### Risk 5: Environment Variable Misconfiguration

**Probability**: Medium
**Impact**: Medium (local/remote mismatch)

**Mitigation**:
- Document all required variables
- Create `.env.local.example`
- Validate variables at app startup
- Clear error messages for missing vars

---

## ‚úÖ Final Success Criteria

### Technical Verification

- [ ] All migrations execute without errors
- [ ] RLS policies properly isolate users
- [ ] TypeScript types generated correctly
- [ ] Frontend apps compile without errors
- [ ] Can read/write transactions from frontend
- [ ] Auth triggers create users automatically

### Security Verification

- [ ] No hardcoded credentials in codebase
- [ ] Environment variables properly managed
- [ ] Service role key never exposed to frontend
- [ ] RLS prevents cross-user data access
- [ ] Anon key has minimal permissions

### Documentation Verification

- [ ] All 4 sub-sprints fully documented
- [ ] MCP setup guide complete
- [ ] Migration workflow documented
- [ ] NestJS archival documented
- [ ] All links work and reference correct files
- [ ] Future developers can follow guides

### Operational Verification

- [ ] Both apps run on correct ports (3100, 3200)
- [ ] Hot reload works during development
- [ ] Build succeeds: `pnpm build`
- [ ] Linting passes: `pnpm lint`
- [ ] Type checking passes: `pnpm check-types`

---

## üìö Related Documentation

### Architecture
- [ADR 001 - Architecture Simplification](../../decisions/001-architecture-simplification.md)
- [Sprint 0.8 Evaluation](./0.8-deployment-evaluation.md)
- [Deployment README](../../deployment/README.md)

### Guides
- [Development Setup](../guides/development.md)
- [MCP Configuration](../guides/mcp-setup.md)
- [Database Migrations](../guides/database-migrations.md)

### Reference
- [Prisma Schema](../../../packages/database/prisma/schema.prisma)
- [Supabase Documentation](https://supabase.com/docs)

---

## üéØ What's Next?

After Sprint 0.9 completion:

**Sprint 1: Authentication**
- Implement Supabase Auth in UI
- Create login/signup pages
- Add protected routes
- Session management

**Sprint 2: Core Features**
- Transaction CRUD in Flow app
- Category management
- Basic filtering and sorting

**Sprint 3: Statistics**
- Transaction summaries
- Category totals
- Monthly reports
- Apex app integration

**Phase 2: Production Readiness**
- Error tracking
- Performance monitoring
- Deployment automation
- User documentation

---

**Document Created**: 2025-11-12
**Last Updated**: 2025-11-12
**Status**: Complete
**Next Review**: After Sprint 0.9.1 completion
```
